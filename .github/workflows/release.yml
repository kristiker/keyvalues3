name: Build and release

on:
  #push:
  #  branches:
  #  - main
  #  paths:
  #  - "setup.py"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.x"

    - name: Get package version
      id: get_version
      run: echo ::set-output name=VERSION::$(python setup.py --version)
    
    - name: Setup build tools
      run: python -m pip install build twine

    - name: Build package
      run: python -m build

    - name: Check package
      run: python -m twine check --strict dist/*

    - name: Publish package, only if correctly tagged
      if: github.ref == format('refs/tags/v{0}', steps.get-version.outputs.VERSION)
      run: python -m twine upload --non-interactive --verbose --disable-progress-bar dist/*
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
